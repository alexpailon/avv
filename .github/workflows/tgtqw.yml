name: Automated Browser Cycle

on:
  workflow_dispatch:
  schedule:
    - cron: "*/10 * * * *"


jobs:
  run-automation:
    runs-on: ubuntu-latest

    env:
      PY_COLORS: "1"
      LANG: en_US.UTF-8

    defaults:
      run:
        shell: bash

    steps:
    # =====================================================
    # 1️⃣ Checkout Source
    # =====================================================
    - name: Pull Repository
      uses: actions/checkout@v4

    # =====================================================
    # 2️⃣ Python Environment
    # =====================================================
    - name: Setup Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"

    - name: Upgrade Pip Stack
      run: |
        python -m pip install --upgrade pip setuptools wheel

    # =====================================================
    # 3️⃣ System Locale + Base Packages
    # =====================================================
    - name: Configure System Locale
      run: |
        sudo apt-get update -y
        sudo apt-get install -y tzdata locales curl apt-transport-https
        sudo locale-gen en_US.UTF-8
        sudo update-locale LANG=en_US.UTF-8
        locale

    # =====================================================
    # 4️⃣ Brave Browser Installation
    # =====================================================
    - name: Install Brave
      run: |
        curl -fsSLo /usr/share/keyrings/brave-browser.gpg \
          https://brave-browser-apt-release.s3.brave.com/brave-browser-archive-keyring.gpg

        echo "deb [signed-by=/usr/share/keyrings/brave-browser.gpg] \
        https://brave-browser-apt-release.s3.brave.com/ stable main" \
        | sudo tee /etc/apt/sources.list.d/brave-browser.list

        sudo apt-get update -y
        sudo apt-get install -y brave-browser

    # =====================================================
    # 5️⃣ Cloudflare WARP Networking
    # =====================================================
    - name: Install & Activate WARP
      run: |
        curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg \
          | sudo gpg --dearmor -o /usr/share/keyrings/cloudflare-warp.gpg

        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/cloudflare-warp.gpg] \
        https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" \
        | sudo tee /etc/apt/sources.list.d/cloudflare-warp.list

        sudo apt-get update -y
        sudo apt-get install -y cloudflare-warp

        sudo warp-cli --accept-tos registration new
        sudo warp-cli --accept-tos mode warp+doh
        sudo warp-cli --accept-tos connect

        sleep 5

    - name: Confirm WARP Tunnel
      run: |
        curl -s https://www.cloudflare.com/cdn-cgi/trace | grep warp=on

    # =====================================================
    # 6️⃣ Python Dependencies
    # =====================================================
    - name: Install Project Dependencies
      run: |
        pip install --upgrade \
          seleniumbase \
          pyautogui \
          pymongo \
          python-xlib

    - name: Install Chromedriver via SeleniumBase
      run: seleniumbase install chromedriver

    # =====================================================
    # 7️⃣ Execute Automation Script
    # =====================================================
    - name: Run chel.py
      run: |
        python chel.py \
          --brave \
          --incognito \
          --do-not-track \
          --xvfb \
          --screenshot

    # =====================================================
    # 8️⃣ Upload Artifacts
    # =====================================================
    - name: Archive SeleniumBase Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-artifacts
        path: ./latest_logs/
